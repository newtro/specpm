# Spec: AI Context Generation (`specpm context`)

**Purpose:** Generate AI-agent-readable context files from installed spec packages so that coding agents can consume specifications during code generation.

## Data Model

### Generated Files
```
.specpm/CLAUDE.md              # Claude Code / Claude context
.cursorrules                    # Cursor rules file (project root)
.github/copilot-instructions.md # GitHub Copilot instructions
.specpm/context/full.md         # Complete merged context (agent-agnostic)
.specpm/context/manifest.json   # What specs contributed to this context
```

### Context Manifest
```json
{
  "generatedAt": "2026-02-18T06:00:00Z",
  "specpmVersion": "0.5.0",
  "packages": [
    { "name": "@auth/oauth2", "version": "2.1.0" }
  ],
  "checksums": {
    "CLAUDE.md": "sha256-...",
    "full.md": "sha256-..."
  }
}
```

## Command

```
specpm context [--target <agent>] [--output <dir>] [--watch]
```

| Flag | Description |
|------|-------------|
| `--target` | Generate for specific agent only: claude, cursor, copilot, all (default: from specpm.yaml) |
| `--output` | Override output directory |
| `--watch` | Re-generate on spec file changes |

Alias: `specpm generate` (same command)

## Behavior

1. Read all installed specs from `.specpm/specs/`
2. For each spec package, extract:
   - Entity schemas → render as TypeScript interfaces or table descriptions
   - State machines → render as state transition descriptions
   - Constraints → render as numbered rules
   - Semantic docs → include as-is
3. Apply overrides from `specpm.yaml`
4. Merge into unified context document, organized by domain
5. Format per target agent:
   - **Claude**: Markdown with `## Specifications` sections, emphasizing constraints
   - **Cursor**: `.cursorrules` format with rules and patterns
   - **Copilot**: Markdown instructions format
6. Write files to appropriate locations
7. Write manifest.json

## Context Document Structure (per agent)
```markdown
# Project Specifications (Auto-generated by SpecPM)
> Do not edit. Regenerate with `specpm context`.

## @auth/oauth2 v2.1.0

### Entities
[rendered JSON Schema as descriptions]

### State Machines
[rendered state transitions]

### Constraints
1. [constraint from spec]
2. [constraint from spec]

### Implementation Notes
[semantic docs content]
```

## Constraints

- Generated files must have "auto-generated, do not edit" header
- Total context size must respect token limits: warn if >50K tokens for any single agent file
- Must not include spec metadata irrelevant to code generation (download counts, etc.)
- Overrides must be applied before generation (excluded fields, renamed entities)
- Generation must be deterministic: same specs → same output
- Must not touch files outside designated output paths

## Edge Cases

- No specs installed → generate empty context with "no specs installed" message
- Spec has invalid schema → skip with warning, generate rest
- Token limit exceeded → truncate with priority ordering (constraints first, then entities, then docs)
- `.cursorrules` already exists with user content → merge (user section + generated section with markers)
- Watch mode: file deleted during watch → regenerate without it

## Acceptance Criteria

- [ ] `specpm context` generates CLAUDE.md from installed specs
- [ ] `specpm context --target cursor` generates .cursorrules
- [ ] Generated files contain all entity schemas, state machines, and constraints
- [ ] Overrides in specpm.yaml are reflected in generated output
- [ ] Token count warning fires when context exceeds 50K tokens
- [ ] Manifest.json accurately reflects generation state
- [ ] Watch mode regenerates on spec file changes
